<html>

<head>
  <title>SQ3SWF Sat Predict</title>
</head>

<style type="text/css">
  pre { margin: 3 0 0 0; display: block; }
  pre:hover { background-color: #dddddd }
  .details { margin: 5 0 5 0; }
</style>

<script>

  function generate_line(s) {
    ll = `[${s.mode.padStart(3)}] <b>${s.name.padEnd(13)}</b> ↑${s.start_str} ↓${s.end_str} (${s.duration_str.padStart(5)}) `
    ll += `in ${s.remaining_str.padStart(5)}  `
    ll += `max el: <b>${String(s.el_max).padStart(2, ' ')}</b>°`
    ll += ` az: ${String(s.az_rise).padStart(3, '0')}-`
    ll += `${String(s.az_peak).padStart(3, '0')}-${String(s.az_set).padStart(3, '0')}`
    if('el_now' in s) {
      ll += `<b>   ↑${String(Math.round(s.el_now)).padStart(2)}°`
      ll += ` →${String(Math.round(s.az_now)).padStart(2)}° </b>`
    }
    return ll
  }

  function generate_status_colors(status) {
    colors = {0: '#4169E1', 1: 'yellow', 2: 'red', 3: 'orange', 4: '#9900FF', 5: 'C0C0C0'}

    out = ""
    for (const s of status) {
      out += `<span style="color: ${colors[s]};">█</span>`;
    }

    return out
  }

  function get_health_perc(status) {
    return Math.round(100*status.filter(x => x === '0').length / status.filter(x => x != '5').length);
  }

  function generate_details_line(s) {
    ll =  ` <b>DOWN:</b> ${s.downlink} | `
    ll += `<b>UP:</b> ${s.uplink} | `
    ll += `<b>BCN:</b> ${s.beacon} | `
    ll += ` <b>Health:</b> ${String(get_health_perc(s.status)).padStart(3)}% \n`
    ll += ` [${generate_status_colors(s.status)}]`
    return ll
  }

  function toggle_visibility() {
    obj = document.getElementById(`det_${event.srcElement.id}`);
    if(obj.style.display == 'none') {
      obj.style.display = 'block';
    }
    else {
      obj.style.display = 'none';
    }
  }

  function update_positions() {
    mainbox = document.getElementById('mainbox');
    var xhr = new XMLHttpRequest();
    xhr.onreadystatechange = function() {
      if (xhr.readyState === 4){

        var selected = [];
        for(const d of document.getElementsByClassName("details")) {
          if(d.style.display == 'block') {
            selected.push(d.id);
          }
        }

        resp = JSON.parse(xhr.responseText);

        var cnt = 0;

        mainbox.innerHTML = '';

        for(const sat of resp) {
          satline = document.createElement("pre");
          satline.id = `${sat.name}_${sat.start_str}`;
          satline.addEventListener("click", toggle_visibility, false);
          satline.innerHTML = generate_line(sat);

          satline_det = document.createElement("pre");
          satline_det.id = `det_${satline.id}`;
          satline_det.innerHTML = generate_details_line(sat);
          satline_det.setAttribute('class', 'details');
          satline_det.style.display = 'none';


          mainbox.appendChild(satline);
          mainbox.appendChild(satline_det);

          cnt++;
        }

        for(const d of selected) {
          document.getElementById(d).style.display = 'block';
        }
      }
    };
    xhr.open('GET', '/predictions?loc=JO82');
    xhr.send();
  }

  document.addEventListener("DOMContentLoaded", function() {
    update_positions();
  });

  window.setInterval(update_positions, 5000);

</script>

<body>

<div id="mainbox"></div>
<div id="footer">
<pre> </pre>
<pre>  <span style="background-color: #4169E1;">  RPT QRV  </span>   <span style="background-color: yellow;">  TELEMETRY  </span>   <span style="background-color: red;">  NO SIGNAL  </span>   <span style="background-color: orange;">  CONFLICTING  </span>   <span style="background-color: #9900FF;">  ISS CREW  </span> </pre>
<pre>     Activity reports - amsat.org. TLE files - amsat.org & celestrak.com.   </pre>
</div>

</body>
